name: CI
on:
 push:
   branches:
     - prod
     - stage
jobs:
  stage:
    runs-on: self-hosted
    name: build example
    if: github.ref == 'refs/heads/stage'
    steps:
    - name: delete replicaset
      run: |
        kubectl delete replicaset example-green-6498d5547b
    - uses: actions/checkout@v2
    - name: Try the cluster !
      run: kubectl get pods -A
    - name: Build images
      run: |
        export SHELL=/bin/bash
        eval $(minikube -p minikube docker-env)
        docker build -t dipak ./stage/
        echo -n "verifying images:"
        docker images 
    - name: Deploy to service
      run: 
        kubectl apply -f menifest.yml
        
  deploy: 
    runs-on: self-hosted
    name: deploy too minikube
    if: github.ref == 'refs/heads/prod'
    steps:
    - name: delete replicaset
      run: |
        kubectl delete replicaset example-blue-85977db98c
    - uses: actions/checkout@v2
    - name: Try the cluster !
      run: kubectl get pods -A
    - name: Build images
      run: |
        export SHELL=/bin/bash
        eval $(minikube -p minikube docker-env)
        docker build -t dipak ./prod/
        echo -n "verifying images:"
        docker images        
    - name: Deploy to service
      run: 
         kubectl apply -f menifest2.yml
  
